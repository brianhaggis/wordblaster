<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Master Control - Word Blaster</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Josefin+Slab:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/static/main.css"/>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
      body { overflow-y: auto; }

      .control-panel {
        max-width: 600px;
        margin: 40px auto;
      }

      /* Secret Box */
      .secret-box {
        border: 1px dashed var(--deco-red);
        background: rgba(50,0,0,0.3);
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
      }

      .secret-word {
        font-family: 'Rye', serif;
        font-size: 2rem;
        color: var(--deco-red);
      }

      .secret-label {
        font-size: 0.8rem;
        font-weight: bold;
        color: var(--deco-gold);
        text-transform: uppercase;
        margin-bottom: 5px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .input-group { margin-bottom: 15px; }

      label {
        display: block;
        color: var(--deco-brass);
        margin-bottom: 5px;
      }

      input[type="text"] {
        width: 100%;
        box-sizing: border-box;
      }

      select {
        width: 100%;
        box-sizing: border-box;
        background: #000;
        border: 2px solid var(--deco-brass);
        color: var(--deco-gold);
        font-family: 'Josefin Slab', serif;
        font-size: 1.3rem;
        padding: 10px;
        cursor: pointer;
      }
      
      select option {
        background: #111;
        color: var(--deco-gold);
        padding: 8px;
      }

      /* Test / Override Zones */
      .test-zone {
        background: rgba(255,255,255,0.05);
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        border: 1px solid #444;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <header class="hero" style="text-align:center; margin-bottom:20px;">
        <h1 style="margin-bottom:0;">MASTER CONTROL BOARD</h1>
      </header>

      <main class="card control-panel">

        <div class="secret-box">
          <div style="font-size:0.9rem; opacity:0.8; text-transform:uppercase; margin-bottom:10px;">
            Current Secret Targets
          </div>

          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div>
              <div id="lblA" class="secret-label">TEAM A TARGET</div>
              <div id="targetA" class="secret-word">...</div>
            </div>
            <div>
              <div id="lblB" class="secret-label">TEAM B TARGET</div>
              <div id="targetB" class="secret-word">...</div>
            </div>
          </div>
        </div>

        <div class="input-group">
          <label>Team A Name</label>
          <select id="nameA">
            <option value="Amber Armadillos">Amber Armadillos</option>
            <option value="Cobalt Capybaras">Cobalt Capybaras</option>
            <option value="Crimson Otters">Crimson Otters</option>
            <option value="Emerald Eels">Emerald Eels</option>
            <option value="Golden Geckos">Golden Geckos</option>
            <option value="Indigo Iguanas">Indigo Iguanas</option>
            <option value="Lavender Llamas">Lavender Llamas</option>
            <option value="Magenta Meerkats">Magenta Meerkats</option>
            <option value="Navy Moose">Navy Moose</option>
            <option value="Orange Ocelots" selected>Orange Ocelots</option>
            <option value="Periwinkle Narwhals">Periwinkle Narwhals</option>
            <option value="Purple Porcupines">Purple Porcupines</option>
            <option value="Scarlet Salamanders">Scarlet Salamanders</option>
            <option value="Teal Turtles">Teal Turtles</option>
          </select>
        </div>

        <div class="input-group">
          <label>Team B Name</label>
          <select id="nameB">
            <option value="Amber Armadillos">Amber Armadillos</option>
            <option value="Cobalt Capybaras">Cobalt Capybaras</option>
            <option value="Crimson Otters">Crimson Otters</option>
            <option value="Emerald Eels">Emerald Eels</option>
            <option value="Golden Geckos">Golden Geckos</option>
            <option value="Indigo Iguanas">Indigo Iguanas</option>
            <option value="Lavender Llamas" selected>Lavender Llamas</option>
            <option value="Magenta Meerkats">Magenta Meerkats</option>
            <option value="Navy Moose">Navy Moose</option>
            <option value="Orange Ocelots">Orange Ocelots</option>
            <option value="Periwinkle Narwhals">Periwinkle Narwhals</option>
            <option value="Purple Porcupines">Purple Porcupines</option>
            <option value="Scarlet Salamanders">Scarlet Salamanders</option>
            <option value="Teal Turtles">Teal Turtles</option>
          </select>
        </div>

        <div style="margin-top:10px; text-align:center;">
          <button id="resetBtn" class="bigbtn" style="font-size:1.5rem; padding:20px;">
            INITIALIZE NEW MATCH
          </button>
          <div style="margin-top:10px; opacity:0.6; font-size:0.9rem;">
            (Resets scores, rotates words, updates names)
          </div>
        </div>

        <div class="test-zone" style="border-color:var(--deco-gold);">
          <label style="text-align:center; color:var(--deco-gold);">
            GAME FLOW OVERRIDE
          </label>

          <div style="text-align:center; margin-top:10px;">
            <button
              id="triggerBtn"
              class="bigbtn"
              style="
                font-size:1.2rem;
                min-height:60px;
                background:radial-gradient(circle,#038a03 0%,#005200 100%) !important;
                box-shadow: inset 0 0 20px #000 !important;
              ">
              TRIGGER (START / SNAP)
            </button>
            <div style="font-size:0.8rem; opacity:0.6; margin-top:5px;">
              (Simulates Bluetooth Button Press)
            </div>
          </div>
        </div>

        <div class="test-zone" style="border-color:var(--deco-red);">
            <label style="text-align:center; color:var(--deco-red);">
              FINALE
            </label>
            <div style="text-align:center; margin-top:10px;">
              <button id="bonusBtn" class="bigbtn" style="background: rgba(150, 0, 0, 0.5);">
                INITIATE BONUS ROUND
              </button>
            </div>
        </div>

        <div class="test-zone">
          <label style="text-align:center; color:var(--deco-brass);">
            MANUAL SCORE JUDGE
          </label>

          <div style="display:flex; gap:10px; margin-top:10px;">
            <input
              type="text"
              id="testWord"
              placeholder="Type a word..."
              style="text-transform:uppercase;"
            >
            <button id="testBtn" class="btn" style="margin:0;">
              SUBMIT
            </button>
          </div>

          <div
            id="testResult"
            style="
              text-align:center;
              margin-top:8px;
              font-size:0.9rem;
              min-height:1.2em;
            ">
          </div>
        </div>

        <div style="margin-top:20px; border-top:1px solid #333; padding-top:10px;">
          <div style="display:flex; justify-content:space-between;">
            <span>Status: <b id="connStatus" style="color:var(--deco-green)">Online</b></span>
            <span>Phase: <b id="phase" style="color:var(--deco-gold)">...</b></span>
          </div>
        </div>

      </main>
    </div>

    <script>
      const socket = io({
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionAttempts: 10,
        timeout: 20000
      });

      const els = {
        nameA: document.getElementById('nameA'),
        nameB: document.getElementById('nameB'),
        targetA: document.getElementById('targetA'),
        targetB: document.getElementById('targetB'),
        lblA: document.getElementById('lblA'),
        lblB: document.getElementById('lblB'),
        phase: document.getElementById('phase'),
        resetBtn: document.getElementById('resetBtn'),
        triggerBtn: document.getElementById('triggerBtn'),
        bonusBtn: document.getElementById('bonusBtn'),
        testWord: document.getElementById('testWord'),
        testBtn: document.getElementById('testBtn'),
        testResult: document.getElementById('testResult')
      };

      socket.on('game_state', (s) => {
        els.phase.textContent = s.phase.toUpperCase();

        els.lblA.textContent = s.teamA.name.toUpperCase() + " TARGET";
        els.lblB.textContent = s.teamB.name.toUpperCase() + " TARGET";
      });

      socket.on('admin_secrets', (data) => {
        els.targetA.textContent = data.A;
        els.targetB.textContent = data.B;
      });

      // INITIALIZE GAME
      els.resetBtn.onclick = () => {
        const original = els.resetBtn.innerText;
        els.resetBtn.innerText = "SENDING...";

        fetch('/start_game', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            teamA: els.nameA.value,
            teamB: els.nameB.value
          })
        })
        .then(() => {
          els.resetBtn.innerText = "UPDATED!";
          setTimeout(() => els.resetBtn.innerText = original, 1000);
        })
        .catch(() => {
          els.resetBtn.innerText = "FAILED";
        });
      };

      // TRIGGER BUTTON
      els.triggerBtn.onclick = () => {
        els.triggerBtn.style.transform = "scale(0.95)";
        setTimeout(() => els.triggerBtn.style.transform = "scale(1)", 100);
        socket.emit('game_trigger');
      };

      // BONUS ROUND BUTTON
      if (els.bonusBtn) {
        els.bonusBtn.onclick = () => {
            const original = els.bonusBtn.innerText;
            els.bonusBtn.innerText = "STARTING...";
            
            // CORRECTED ENDPOINT: /init_bonus
            fetch('/init_bonus', { method: 'POST' })
            .then(() => {
                els.bonusBtn.innerText = "BONUS STARTED";
                setTimeout(() => els.bonusBtn.innerText = original, 2000);
            })
            .catch(err => {
                console.error(err);
                els.bonusBtn.innerText = "ERROR";
            });
        };
      }

      // MANUAL WORD SUBMIT
      els.testBtn.onclick = async () => {
        const word = els.testWord.value.trim();
        if (!word) return;

        els.testBtn.textContent = "...";
        els.testResult.textContent = "";

        try {
          const res = await fetch('/submit', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ word })
          });
          const data = await res.json();

          if (data.valid) {
            els.testResult.textContent = `SUCCESS: ${word.toUpperCase()} (+${data.points})`;
            els.testResult.style.color = "#00ff00";
          } else {
            els.testResult.textContent = `REJECTED: ${data.reason}`;
            els.testResult.style.color = "#ff0000";
          }
        } catch (e) {
          els.testResult.textContent = "ERROR";
        }

        els.testBtn.textContent = "SUBMIT";
        els.testWord.value = "";
        els.testWord.focus();
      };

      els.testWord.addEventListener("keypress", (e) => {
        if (e.key === "Enter") els.testBtn.click();
      });
    </script>
  </body>
</html>